{% extends "base.html" %} {% block title %}Admin Login - Dining Hall{% endblock
%} {% block content %}
<div class="login-container">
  <h1>Admin Login</h1>

  {% if oauth_enabled %}
  <div class="oauth-section">
    <button type="button" class="btn btn-microsoft" onclick="loginWithMicrosoft()">
      <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
        <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
        <rect x="1" y="10" width="9" height="9" fill="#00A4EF"/>
        <rect x="10" y="1" width="9" height="9" fill="#7FBA00"/>
        <rect x="10" y="10" width="9" height="9" fill="#FFB900"/>
      </svg>
      Login with Microsoft
    </button>
    <div class="divider">
      <span>or</span>
    </div>
  </div>
  {% endif %}

  <form id="loginForm" method="post" action="/admin/login">
    <div class="form-group">
      <label for="username">Username:</label>
      <input
        type="text"
        id="username"
        name="username"
        class="form-control"
        required
      />
    </div>

    <div class="form-group">
      <label for="password">Password:</label>
      <input
        type="password"
        id="password"
        name="password"
        class="form-control"
        required
      />
    </div>

    <button type="submit" class="btn btn-primary">Login</button>
  </form>

  {% if error %}
  <div class="error-message">{{ error }}</div>
  {% endif %}
</div>

<script>
  function loginWithMicrosoft() {
    // Show loading state
    const button = document.querySelector('.btn-microsoft');
    const originalText = button.innerHTML;
    button.innerHTML = '<span>Loading...</span>';
    button.disabled = true;

    // Redirect to the OAuth authorization endpoint
    window.location.href = "/oauth/login";
  }

  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = {
      username: formData.get("username"),
      password: formData.get("password"),
    };

    try {
      console.log("Sending login request...");
      const response = await fetch("/admin/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
        credentials: "include", // Include cookies/session in the request
      });

      console.log("Login response status:", response.status);
      console.log("Login response ok:", response.ok);

      if (response.ok) {
        console.log("Login successful, redirecting to /admin");
        try {
          // Try to parse JSON, but if it fails, still redirect
          const responseData = await response.json();
          console.log("Login response data:", responseData);
        } catch (e) {
          console.error("Error parsing JSON, but proceeding with redirect:", e);
        }
        // Force a hard redirect to ensure the browser handles it
        // Add a small delay to ensure session cookie is properly set
        setTimeout(() => {
          window.location.replace("/admin");
        }, 100);
      } else {
        const errorText = await response.text();
        console.error("Login failed with response:", errorText);
        alert("Login failed: " + errorText);
      }
    } catch (error) {
      console.error("Login fetch error:", error);
      alert("Login error: " + error.message);
    }
  });
</script>

{% endblock %}
